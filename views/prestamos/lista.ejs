<%- include('../Parcial/header') %>

<div class="page-header">
  <h2>ðŸ“‹ <%= usuario.role === 'administrador' ? 'Todos los PrÃ©stamos' : 'Mis PrÃ©stamos' %></h2>
  <% if (usuario && usuario.role === 'administrador') { %>
    <a href="/prestamos/nuevo" class="btn">+ Nuevo PrÃ©stamo</a>
  <% } %>
</div>

<% if (prestamos.length === 0) { %>
  <p class="empty-message">
    <% if (usuario.role === 'administrador') { %>
      No hay prÃ©stamos registrados.
    <% } else { %>
      No tienes prÃ©stamos registrados.
    <% } %>
  </p>
<% } else { %>
  <div class="tabla-contenedor">
    <table>
      <thead>
        <tr>
          <th>Libro</th>
          <th>Usuario</th>
          <th>Fecha PrÃ©stamo</th>
          <th>Fecha DevoluciÃ³n</th>
          <th>Estado</th>
          <% if (usuario && usuario.role === 'administrador') { %>
            <th>Acciones</th>
          <% } %>
        </tr>
      </thead>
      <tbody>
        <% prestamos.forEach(prestamo => { %>
        <tr class="<%= prestamo.devuelto ? 'fila-devuelto' : '' %>">
          <td><strong><%= prestamo.libroId ? prestamo.libroId.titulo : 'Libro eliminado' %></strong></td>
          <td><%= prestamo.nombreUsuario %></td>
          <td><%= new Date(prestamo.fechaPrestamo).toLocaleDateString('es-MX') %></td>
          <td>
            <%= new Date(prestamo.fechaDevolucion).toLocaleDateString('es-MX') %>
            <% if (!prestamo.devuelto && new Date(prestamo.fechaDevolucion) < new Date()) { %>
              <span class="badge vencido">Â¡Vencido!</span>
            <% } %>
          </td>
          <td>
            <% if (prestamo.devuelto) { %>
              <span class="badge devuelto">Devuelto</span>
              <% if (prestamo.fechaDevolucionReal) { %>
                <br><small>El <%= new Date(prestamo.fechaDevolucionReal).toLocaleDateString('es-MX') %></small>
              <% } %>
            <% } else { %>
              <span class="badge prestado">Pendiente</span>
            <% } %>
          </td>
          <% if (usuario && usuario.role === 'administrador') { %>
          <td>
            <a href="/prestamos/<%= prestamo._id %>/editar" class="btn-small">Editar</a>
            <form action="/prestamos/<%= prestamo._id %>?_method=DELETE" method="POST" style="display: inline;">
              <button type="submit" class="btn-small btn-danger" onclick="return confirm('Â¿Eliminar este prÃ©stamo?')">Eliminar</button>
            </form>
          </td>
          <% } %>
        </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
<% } %>

<%- include('../Parcial/footer') %>